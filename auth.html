<script>
  const LS_USERS = "tap_users";
  const LS_SESSION = "tap_session";

  function loadUsers() {
    return JSON.parse(localStorage.getItem(LS_USERS) || "{}");
  }
  function saveUsers(users) {
    localStorage.setItem(LS_USERS, JSON.stringify(users));
  }
  function setSession(sess) {
    localStorage.setItem(LS_SESSION, JSON.stringify(sess));
  }

  // ✅ Grab elements safely
  const suUser = document.getElementById("suUser");
  const suPass = document.getElementById("suPass");
  const signupBtn = document.getElementById("signupBtn");
  const suMsg = document.getElementById("suMsg");

  const liUser = document.getElementById("liUser");
  const liPass = document.getElementById("liPass");
  const loginBtn = document.getElementById("loginBtn");
  const liMsg = document.getElementById("liMsg");

  // Optional: press Enter to submit
  suPass.addEventListener("keydown", (e) => {
    if (e.key === "Enter") signupBtn.click();
  });
  liPass.addEventListener("keydown", (e) => {
    if (e.key === "Enter") loginBtn.click();
  });

  // SIGN UP
  signupBtn.addEventListener("click", () => {
    const username = suUser.value.trim();
    const password = suPass.value;

    if (!username || !password) {
      suMsg.className = "msg bad";
      suMsg.textContent = "Fill all fields.";
      return;
    }

    // Simple username rules (prevents weird bugs)
    if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
      suMsg.className = "msg bad";
      suMsg.textContent = "Use 3–20 chars: letters, numbers, underscore.";
      return;
    }

    const users = loadUsers();
    if (users[username]) {
      suMsg.className = "msg bad";
      suMsg.textContent = "Username already exists.";
      return;
    }

    users[username] = {
      displayName: username,
      password: password,
      taps: 0
    };

    saveUsers(users);
    setSession({ username });

    suMsg.className = "msg ok";
    suMsg.textContent = "Account created!";
    setTimeout(() => (location.href = "index.html"), 600);
  });

  // LOGIN
  loginBtn.addEventListener("click", () => {
    const username = liUser.value.trim();
    const password = liPass.value;

    const users = loadUsers();
    if (!users[username] || users[username].password !== password) {
      liMsg.className = "msg bad";
      liMsg.textContent = "Wrong username or password.";
      return;
    }

    setSession({ username });
    liMsg.className = "msg ok";
    liMsg.textContent = "Logged in!";
    setTimeout(() => (location.href = "index.html"), 600);
  });
</script>
